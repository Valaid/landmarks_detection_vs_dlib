# Инструкция к запуску


## Introduction 
Этот репозиторий содержит исследование алгоритмов детекций ключевых точек лиц.


### 1. Подготовка данных (обработка изображений детектором лиц dlib).
Для подготовки данных необходимо загрузить и распаковать архив в директорию data/. Затем выполните следующую команду.
```
python prepare_data_boxes.py --data <директория с распакованным архивом> --iou_threshold <пороговое значение iou детекции лица и бокса из крайних координат ключевых точек>
```

### 2. Обучение моделей.

#### 2.1. Обучение модели Onet.

```
python train_inf_onet.py --mode train --cuda(если есть возможность ее использовать) --batch_size <размер батча> --num_workers 8 --output_path <директория для сохранения весов обученной модели> --max_outbox_points <допустимое количество точек вне детекции лица> --max_epoch <количество эпох обучения> --base_lr <стартовое значения шага оптимизатора> --step_scheduler <количество эпох до уменьшения размера шага>
```

#### 2.2. Обучение модели HRNet.

```
python train_HRnet.py --path_model_weights <директория для сохранения лучших весов модели>
```

### 3. Инференс моделей.

#### 3.1. Инференс модели Onet.

```
python train_inf_onet.py --mode inference --cuda(если есть возможность ее использовать) --batch_size <размер батча> --num_workers 8 --max_outbox_points <допустимое количество точек вне детекции лица> --output_path <директория с сохраненными весами модели> --dataset <тестовый датасет 300W/Menpo>
```
#### 3.2. Инференс модели HRNet.

```
python inference_HRnet.py --dataset <тестовый датасет 300W/Menpo> --path_model_weights <Укажите путь к весам модели из директории HRNet-Facial-Landmark-Detection> --prediction_name <имя файла predition_*.pth для сохранения результата модели> --result_dir <директория для сохранения результатов модели>
```
#### 3.3. Инференс модели HRNet с предобученными весами.
```
python inference_HRnet.py --dataset <тестовый датасет 300W/Menpo> --path_model_weights hrnetv2_pretrained --prediction_name <имя файла predition_*.pth для сохранения результата модели> --result_dir <директория для сохранения результатов модели>
```

### 4. Получения результатов работы библиотеки dlib.

```
python dlib_inference.py --result_dir <директория для сохранения результатов модели> --dataset <тестовый датасет 300W/Menpo>
```

### 5. Подсчет метрики СED, построение графиков метрик CED и вычисление площади под кривой.

```
python count_ced_for_points.py --gt_path <директория с лейблами> --prediction_path <директория с предсказаниями модели> (при наличии нескольких результатов модели указывайте аргумент 'prediction_path' для каждой) --output_path <путь для сохранения графика> --max_points_to_read 1000 --dataset <тестовый датасет на котором были получены предсказания моделей '300W/Menpo'> --error_thr <граничное значение ошибки>
```
